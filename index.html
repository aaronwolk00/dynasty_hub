<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynasty Playoff Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Free fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="app">
    <!-- ==========================================================
         Header: Title + Week Controls
    =========================================================== -->
    <header class="top-bar">
      <div>
        <div class="top-bar-title">Playoff Hub</div>
        <div class="top-bar-subtitle" id="league-subtitle">
          Loading league info…
        </div>
      </div>

      <div class="controls">
        <label>
          Week
          <select id="week-select"></select>
        </label>
        <button id="refresh-btn" type="button">Refresh</button>
      </div>
    </header>

    <!-- ==========================================================
         Main Layout – single panel, app-level tabs
    =========================================================== -->
    <main class="layout">
      <section class="panel">
        <!-- Top-level tabs -->
        <nav class="top-tabs" aria-label="Primary views">
          <button id="tab-newsletter-btn" class="tab-btn active" data-tab="newsletter">Newsletter</button>
          <button id="tab-rosters-btn" class="tab-btn" data-tab="rosters">Rosters</button>
          <button id="tab-season-btn" class="tab-btn" data-tab="season">Season</button>
          <button id="tab-insights-btn" class="tab-btn" data-tab="insights">Insights</button>
          <button id="tab-receipts-btn" class="tab-btn" data-tab="receipts">Receipts</button>
        </nav>

        <!-- ======================================================
             TAB: Newsletter (snapshot)
        ======================================================= -->
        <section id="tab-newsletter" class="tab-panel active">
            <h2>Newsletter</h2>
          
            <div class="newsletter-shell">
              <!-- LEFT: snapshot + matchup list + extras -->
              <div class="newsletter-main">
                <section class="newsletter-card week-brief-card">
                  <div class="week-brief-left">
                    <div class="kicker">Week Brief</div>
                    <div class="week-brief-title">This Week’s Snapshot</div>
                    <div id="week-brief-blurb" class="week-brief-blurb small">Loading…</div>
                  </div>
          
                  <button id="open-summary-btn" type="button" class="ghost-btn">
                    Open Summary
                  </button>
                </section>
          
                <div class="newsletter-head">
                  <div>
                    <div class="kicker">Matchups</div>
                    <div id="newsletter-week-title" class="newsletter-week-title">—</div>
                    <div id="newsletter-week-subtitle" class="newsletter-week-subtitle small">—</div>
                  </div>
                  <div class="small newsletter-head-right">Projected points, win odds, records</div>
                </div>
          
                <div id="matchups-container" class="matchups-scroll">
                  <div class="loading">Loading matchups…</div>
                </div>
          
                <div id="newsletter-extras"></div>
              </div>
          
              <!-- RIGHT: matchup detail rail -->
              <aside class="newsletter-aside">
                <section class="newsletter-card detail-card">
                  <header class="detail-card-header">
                    <div>
                      <div class="kicker">Matchup Detail</div>
                      <div id="detail-title" class="detail-title">Select a matchup</div>
                    </div>
          
                    <div class="segmented" role="tablist" aria-label="Detail filters">
                      <button id="detail-filter-starters" class="seg-btn active" type="button" data-detail="starters">
                        Starters
                      </button>
                      <button id="detail-filter-all" class="seg-btn" type="button" data-detail="all">
                        All
                      </button>
                    </div>
                  </header>
          
                  <div id="matchup-detail-container">
                    <div class="loading">Select a matchup from the left.</div>
                  </div>
          
                  <div class="small tip">
                    Tip: click table headers to toggle columns (where supported).
                  </div>
                </section>
              </aside>
            </div>
          
            <dialog id="summary-dialog" class="summary-dialog">
              <form method="dialog" class="summary-dialog-inner">
                <header class="summary-dialog-header">
                  <div>
                    <div class="kicker">Week Summary</div>
                    <div id="summary-dialog-title" class="summary-title">—</div>
                  </div>
                  <button id="summary-dialog-close" class="ghost-btn" value="close">Close</button>
                </header>
                <div id="summary-dialog-body" class="summary-dialog-body small"></div>
              </form>
            </dialog>
          </section>
          

        <!-- ======================================================
             TAB: Rosters
        ======================================================= -->
        <section id="tab-rosters" class="tab-panel" aria-labelledby="tab-rosters-btn">
          <h2>Rosters</h2>

          <div class="roster-controls">
            <div id="roster-select" class="roster-selector-grid">
              <!-- Populated once __LAST_BUNDLE__ is available -->
            </div>
          </div>

          <div id="roster-view-container">
            <div class="loading">
              Select one or more teams above to view their rosters.
            </div>
          </div>
        </section>

        <!-- ======================================================
             TAB: Receipts
        ======================================================= -->
        <section id="tab-receipts" class="tab-panel" aria-labelledby="tab-receipts-btn">
          <h2>Receipts</h2>
          <div id="receipts-summary"></div>
          <div id="receipts-list"></div>
        </section>

        <!-- ======================================================
             TAB: Season Overview
        ======================================================= -->
        <section id="tab-season" class="tab-panel" aria-labelledby="tab-season-btn">
          <h2>Season Overview</h2>

          <div id="season-overview-root" class="season-overview">
            <!-- Left: Standings -->
            <section>
              <h3 class="season-subheading">Standings</h3>
              <div class="season-standings-container">
                <table class="season-standings-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th>W-L-T</th>
                      <th>Win%</th>
                      <th>PF</th>
                      <th>PA</th>
                      <th>Diff</th>
                    </tr>
                  </thead>
                  <tbody id="season-standings-body">
                    <tr>
                      <td colspan="7" class="small">
                        Standings will populate once historical scores are available.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            <!-- Right: Season metrics / storylines -->
            <section>
              <h3 class="season-subheading">Analytics Snapshot</h3>
              <div id="season-metrics-container" class="season-metrics-container">
                <p class="small">
                  Season metrics will appear here once data loads: top scorers, best differentials,
                  schedule strength notes, and storyline blurbs.
                </p>
              </div>
            </section>
          </div>
        </section>

        <!-- ======================================================
             TAB: Insights
        ======================================================= -->
        <section id="tab-insights" class="tab-panel" aria-labelledby="tab-insights-btn">
          <h2>Insights</h2>

          <div class="season-overview">
            <!-- Left: charts -->
            <section>
              <h3 class="season-subheading">Schedule Luck</h3>
              <div class="chart-card" style="height: 220px;">
                <canvas id="insights-luck-chart"></canvas>
              </div>

              <h3 class="season-subheading" style="margin-top: 14px;">Boom / Bust Profile</h3>
              <div class="chart-card" style="height: 220px;">
                <canvas id="insights-boom-bust-chart"></canvas>
              </div>
            </section>

            <!-- Right: Team analytics table -->
            <section>
              <h3 class="season-subheading">Team Analytics</h3>
              <div class="season-standings-container">
                <table class="season-standings-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th>W-L-T</th>
                      <th>PPG</th>
                      <th>Luck ΔW</th>
                      <th>vs Avg</th>
                      <th>Boom</th>
                      <th>Bust</th>
                    </tr>
                  </thead>
                  <tbody id="insights-table-body">
                    <tr>
                      <td colspan="8" class="small">
                        Insights will populate once historical scores are available.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="small" style="margin-top: 8px;">
                <strong>Key:</strong> Luck ΔW = actual wins minus expected wins from all-play.
                “vs Avg” = record vs the weekly league-average score.
                Boom/Bust = weeks above μ + σ or below μ – σ.
              </p>
            </section>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- ==========================================================
       Vendor: Chart.js
  =========================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ==========================================================
       Sleeper player metadata preload (player_id → name/pos/team)
  =========================================================== -->
  <script>
    window.__PLAYER_MAP_READY__ = (async function preloadSleeperPlayers() {
      try {
        const res = await fetch("https://api.sleeper.app/v1/players/nfl");
        const data = await res.json();
        const map = {};
        for (const [id, p] of Object.entries(data)) {
          map[id] = {
            full_name:
              p.full_name ||
              ((p.first_name || "") + " " + (p.last_name || "")).trim(),
            position: p.position,
            team: p.team,
            color: p.team_color || "#9ca3af",
          };
        }
        window.__SLEEPER_PLAYER_MAP__ = map;
        console.log("[player-map] Loaded", Object.keys(map).length, "players");
        return map;
      } catch (err) {
        console.warn("[player-map] Failed to load Sleeper player map", err);
        window.__SLEEPER_PLAYER_MAP__ = {};
        return {};
      }
    })();
  </script>

  <!-- ==========================================================
       Supabase + Phrase Engine (for recap lines + KTC)
  =========================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="league_config.js"></script>
  <script type="module" src="supabase.js"></script>
  <script src="phrases.js"></script>
  <script type="module" src="ktc_client.js"></script>

  <!-- ==========================================================
       App scripts – order matters
  =========================================================== -->
  <script src="sleeper_client.js"></script>
  <script src="models.js"></script>
  <script src="projections.js"></script>
  <script src="newsletter.js"></script>
  <script src="charts.js"></script>
  <script src="team_profile.js"></script>
  <script type="module" src="receipts.js"></script>
  <script src="insights.js"></script>

  <!-- ==========================================================
       Inline bootstrap: tabs + roster view + new toggles
  =========================================================== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      initTabs();
      initWeekSummaryToggle();
      initMatchupDetailScopeToggle();
      initRostersTab();
    });

    // ------------------------------------------------------------
    // Tabs
    // ------------------------------------------------------------
    function initTabs() {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab");
          if (!target) return;

          tabButtons.forEach((b) => b.classList.remove("active"));
          tabPanels.forEach((p) => p.classList.remove("active"));

          btn.classList.add("active");
          const panel = document.getElementById("tab-" + target);
          if (panel) panel.classList.add("active");
        });
      });
    }

    // ------------------------------------------------------------
    // Week Brief (Open Summary toggle)
    // ------------------------------------------------------------
    function initWeekSummaryToggle() {
      const root = document.getElementById("week-brief");
      const btn = document.getElementById("toggle-summary");
      if (!root || !btn) return;

      btn.addEventListener("click", () => {
        const isOpen = root.classList.toggle("open");
        btn.textContent = isOpen ? "Close Summary" : "Open Summary";
      });
    }

    // ------------------------------------------------------------
    // Matchup Detail scope toggle (Starters / All)
    //
    // This sets:
    //   window.__MATCHUP_DETAIL_SCOPE__ = "starters" | "all"
    // And dispatches:
    //   window event "matchup-detail-scope"
    // so newsletter.js can re-render detail appropriately.
    // ------------------------------------------------------------
    function initMatchupDetailScopeToggle() {
      const btnStarters = document.getElementById("detail-scope-starters");
      const btnAll = document.getElementById("detail-scope-all");
      const container = document.getElementById("matchup-detail-container");

      if (!btnStarters || !btnAll || !container) return;

      function setScope(scope) {
        const isStarters = scope === "starters";
        window.__MATCHUP_DETAIL_SCOPE__ = scope;
        container.setAttribute("data-detail-scope", scope);

        btnStarters.classList.toggle("active", isStarters);
        btnAll.classList.toggle("active", !isStarters);

        btnStarters.setAttribute("aria-selected", isStarters ? "true" : "false");
        btnAll.setAttribute("aria-selected", !isStarters ? "true" : "false");

        window.dispatchEvent(
          new CustomEvent("matchup-detail-scope", { detail: { scope } })
        );
      }

      btnStarters.addEventListener("click", () => setScope("starters"));
      btnAll.addEventListener("click", () => setScope("all"));

      // default
      setScope("starters");
    }

    // ------------------------------------------------------------
    // Rosters tab: KTC-aware roster view (your original, unchanged)
    // ------------------------------------------------------------
    function initRostersTab() {
      const rosterSelect = document.getElementById("roster-select");
      const rosterContainer = document.getElementById("roster-view-container");

      if (!rosterSelect || !rosterContainer) return;

      let currentBundle = null;
      const selectedIds = new Set();

      const sleeperPlayerMap = () => window.__SLEEPER_PLAYER_MAP__ || {};

      const isKtcAvailable = () =>
        window.KTCClient &&
        typeof window.KTCClient.getBestValueForSleeperId === "function";

      function getPlayerKtc(playerId) {
        if (!isKtcAvailable()) return null;
        const raw = window.KTCClient.getBestValueForSleeperId(String(playerId));
        const n = Number(raw);
        return Number.isFinite(n) && n > 0 ? n : null;
      }

      function computeRosterKtc(roster) {
        if (!roster || !isKtcAvailable()) {
          return { total: null, perPlayer: {} };
        }

        const allPlayers =
          Array.isArray(roster.players) && roster.players.length
            ? roster.players
            : roster.starters || [];

        const perPlayer = {};
        let total = 0;

        allPlayers.forEach((pid) => {
          const val = getPlayerKtc(pid);
          if (val != null) {
            const key = String(pid);
            perPlayer[key] = val;
            total += val;
          }
        });

        return { total, perPlayer };
      }

      function renderRosters(ids, rosters, users) {
        if (!ids.length) {
          rosterContainer.innerHTML =
            '<div class="loading">Select one or more teams above to view their rosters.</div>';
          return;
        }

        const players = sleeperPlayerMap();

        const cardsHtml = ids
          .map((id) => {
            const roster = rosters.find((r) => r.roster_id === id);
            if (!roster) return "";

            const user = users.find((u) => u.user_id === roster.owner_id);
            const name =
              (user && (user.display_name || user.username)) ||
              (roster.metadata && roster.metadata.team_name) ||
              `Team ${id}`;

            const starters = Array.isArray(roster.starters)
              ? roster.starters
              : [];

            const { total: teamKtcTotal, perPlayer: ktcById } =
              computeRosterKtc(roster);

            const teamKtcLine =
              teamKtcTotal != null
                ? `<span class="small">Total KTC: ${teamKtcTotal.toFixed(0)}</span>`
                : `<span class="small">Total KTC: <span class="muted">${
                    isKtcAvailable()
                      ? "Calculating / no values"
                      : "Unavailable"
                  }</span></span>`;

            const playerList = starters
              .map((pid) => {
                const key = String(pid);
                const meta = players[key] || {};
                const fullName = meta.full_name || key;
                const pos = meta.position || "";
                const team = meta.team || "";
                const ktc = ktcById[key];

                const ktcCell =
                  ktc != null
                    ? `KTC: ${ktc.toFixed(0)}`
                    : isKtcAvailable()
                    ? '<span class="muted">KTC: –</span>'
                    : "";

                return `
                  <div class="roster-player">
                    <span class="player-pos">${pos}</span>
                    <span class="player-name">${fullName}</span>
                    <span class="player-team">${team}</span>
                    <span class="player-ktc">${ktcCell}</span>
                  </div>`;
              })
              .join("");

            return `
              <article class="roster-card">
                <header class="roster-header">
                  <div>
                    <strong>${name}</strong>
                    <span class="small">Roster ID: ${id}</span>
                  </div>
                  <div class="roster-ktc-summary">
                    ${teamKtcLine}
                  </div>
                </header>
                ${
                  playerList ||
                  "<p class='small'>No starters listed for this roster.</p>"
                }
              </article>`;
          })
          .join("");

        rosterContainer.innerHTML =
          cardsHtml || "<p class='small'>No matching rosters.</p>";
      }

      function buildRosterSelector(bundle) {
        const users = bundle.users || [];
        const rosters = bundle.rosters || [];

        const rosterNameMap = {};
        rosters.forEach((r) => {
          const owner = users.find((u) => u.user_id === r.owner_id);
          const display =
            (r.metadata && r.metadata.team_name) ||
            (owner && (owner.display_name || owner.username)) ||
            `Team ${r.roster_id}`;
          rosterNameMap[r.roster_id] = display;
        });

        rosterSelect.innerHTML = Object.entries(rosterNameMap)
          .map(
            ([id, name]) =>
              `<button type="button" class="roster-select-btn" data-id="${id}">${name}</button>`
          )
          .join("");

        rosterSelect.addEventListener("click", (e) => {
          const btn = e.target.closest(".roster-select-btn");
          if (!btn) return;

          const id = Number(btn.dataset.id);
          if (!Number.isFinite(id)) return;

          if (selectedIds.has(id)) {
            selectedIds.delete(id);
            btn.classList.remove("selected");
          } else {
            selectedIds.add(id);
            btn.classList.add("selected");
          }

          if (!currentBundle) return;

          renderRosters(
            Array.from(selectedIds),
            currentBundle.rosters || [],
            currentBundle.users || []
          );
        });
      }

      // Poll for __LAST_BUNDLE__ produced by newsletter.js
      const poll = setInterval(() => {
        const bundle = window.__LAST_BUNDLE__;
        if (!bundle || !bundle.rosters || !bundle.users) return;

        clearInterval(poll);
        currentBundle = bundle;
        buildRosterSelector(bundle);

        rosterContainer.innerHTML =
          '<div class="loading">Select one or more teams above to view their rosters.</div>';
      }, 400);

      // Listen for KTC readiness and re-render if needed
      if (window.KTCClient && typeof window.KTCClient.whenReady === "function") {
        window.KTCClient
          .whenReady()
          .then(() => {
            if (currentBundle && selectedIds.size) {
              renderRosters(
                Array.from(selectedIds),
                currentBundle.rosters || [],
                currentBundle.users || []
              );
            }
          })
          .catch((err) => {
            console.warn("[rosters] KTCClient.whenReady() failed:", err);
          });
      }
    }
  </script>
</body>
</html>
