<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynasty Playoff Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="app">
    <!-- ==========================================================
         Header: Title + Week Controls
    =========================================================== -->
    <header class="top-bar">
      <div>
        <div class="top-bar-title">Playoff Hub</div>
        <div class="top-bar-subtitle" id="league-subtitle">Loading league info…</div>
      </div>

      <div class="controls">
        <label>
          Week
          <select id="week-select" aria-label="Select week"></select>
        </label>
        <button id="refresh-btn" type="button">Refresh</button>
      </div>
    </header>

    <!-- ==========================================================
         Main Layout – single panel, app-level tabs
    =========================================================== -->
    <main class="layout">
      <section class="panel">
        <!-- Top-level tabs -->
        <nav class="top-tabs" aria-label="Primary views" role="tablist">
          <button id="tab-newsletter-btn" class="tab-btn active" data-tab="newsletter" role="tab" aria-selected="true">
            Newsletter
          </button>
          <button id="tab-rosters-btn" class="tab-btn" data-tab="rosters" role="tab" aria-selected="false">
            Rosters
          </button>
          <button id="tab-season-btn" class="tab-btn" data-tab="season" role="tab" aria-selected="false">
            Season
          </button>
          <button id="tab-insights-btn" class="tab-btn" data-tab="insights" role="tab" aria-selected="false">
            Insights
          </button>
          <button id="tab-receipts-btn" class="tab-btn" data-tab="receipts" role="tab" aria-selected="false">
            Receipts
          </button>
        </nav>

        <!-- ======================================================
             TAB: Newsletter
        ======================================================= -->
        <section id="tab-newsletter" class="tab-panel active" role="tabpanel" aria-labelledby="tab-newsletter-btn">
          <h2>Newsletter</h2>

          <div class="newsletter-shell">
            <!-- LEFT -->
            <div class="newsletter-main">
              <section class="newsletter-card week-brief-card" aria-label="Week brief">
                <div class="week-brief-left">
                  <div class="kicker">Week Brief</div>
                  <div id="week-brief-title" class="week-brief-title">This Week’s Snapshot</div>
                  <div id="week-brief-text" class="week-brief-blurb small">Loading…</div>
                </div>

                <button id="open-summary-btn" type="button" class="ghost-btn">
                  Open Summary
                </button>
              </section>

              <div class="newsletter-head">
                <div>
                  <div class="kicker">Matchups</div>
                  <div id="newsletter-week-title" class="newsletter-week-title">—</div>
                  <div id="newsletter-week-subtitle" class="newsletter-week-subtitle small">—</div>
                </div>
                <div class="small newsletter-head-right">Projected points, win odds, records</div>
              </div>

              <!-- This is the matchup list your newsletter.js renders into -->
              <div id="matchups-container" class="matchups-scroll" aria-label="Matchups list">
                <div class="loading">Loading matchups…</div>
              </div>

              <!-- Optional: playoff charts (prevents charts.js “canvas not found” errors) -->
              <section class="newsletter-card" aria-label="Playoff odds">
                <div class="kicker">Playoff Odds</div>
                <div class="small" style="margin-top:6px;">Semifinal & championship likelihood (when applicable).</div>

                <div class="chart-card" style="height: 190px; margin-top: 10px;">
                  <canvas id="semifinal-odds-chart" aria-label="Semifinal odds chart"></canvas>
                </div>

                <div class="chart-card" style="height: 190px; margin-top: 10px;">
                  <canvas id="championship-odds-chart" aria-label="Championship odds chart"></canvas>
                </div>
              </section>

              <!-- Where your “League Pulse” / extras should render (if you add the anchors there) -->
              <div id="newsletter-extras"></div>

              <!-- Compatibility target: some builds of newsletter.js render a full newsletter body here.
                   We keep it present to avoid null refs without changing your layout. -->
              <div id="newsletter-content" hidden></div>
            </div>

            <!-- RIGHT: matchup detail rail -->
            <aside class="newsletter-aside" aria-label="Matchup detail">
              <section class="newsletter-card detail-card">
                <header class="detail-card-header">
                  <div>
                    <div class="kicker">Matchup Detail</div>
                    <div id="matchup-detail-title" class="detail-title">Select a matchup</div>
                  </div>

                  <div class="segmented" role="tablist" aria-label="Detail filters">
                    <button
                      id="detail-filter-starters"
                      class="seg-btn active"
                      type="button"
                      data-detail="starters"
                      role="tab"
                      aria-selected="true"
                    >
                      Starters
                    </button>
                    <button
                      id="detail-filter-all"
                      class="seg-btn"
                      type="button"
                      data-detail="all"
                      role="tab"
                      aria-selected="false"
                    >
                      All
                    </button>
                  </div>
                </header>

                <div id="matchup-detail-container">
                  <div class="loading">Select a matchup from the left.</div>
                </div>

                <div class="small tip">
                  Tip: click table headers to toggle columns (where supported).
                </div>
              </section>
            </aside>
          </div>

          <!-- Summary dialog -->
          <dialog id="summary-dialog" class="summary-dialog">
            <form method="dialog" class="summary-dialog-inner">
              <header class="summary-dialog-header">
                <div>
                  <div class="kicker">Week Summary</div>
                  <div id="summary-dialog-title" class="summary-title">—</div>
                </div>
                <button id="summary-dialog-close" class="ghost-btn" value="close" type="submit">
                  Close
                </button>
              </header>
              <div id="summary-dialog-body" class="summary-dialog-body small"></div>
            </form>
          </dialog>
        </section>

        <!-- ======================================================
             TAB: Rosters
        ======================================================= -->
        <section id="tab-rosters" class="tab-panel" role="tabpanel" aria-labelledby="tab-rosters-btn">
          <h2>Rosters</h2>

          <div class="rosters-layout">
            <div class="roster-controls">
              <div id="roster-select" class="roster-selector-grid">
                <div class="loading small">Loading rosters…</div>
              </div>
            </div>

            <div id="roster-view-container" class="roster-view">
              <section class="newsletter-card detail-card">
                <header class="detail-card-header">
                  <div>
                    <div class="kicker">Roster Detail</div>
                    <div id="roster-detail-header" class="detail-title">Select a team</div>
                  </div>
                </header>

                <div class="roster-detail-table-wrapper">
                  <table class="season-standings-table roster-detail-table">
                    <thead>
                      <tr>
                        <th>Slot</th>
                        <th>Player</th>
                        <th>Pos / Team</th>
                        <th>KTC</th>
                      </tr>
                    </thead>
                    <tbody id="roster-detail-body">
                      <tr>
                        <td colspan="4" class="small muted">
                          Select a team above to view its full roster (Starters, Bench, Taxi, IR).
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
          </div>
        </section>

        <!-- ======================================================
             TAB: Receipts
        ======================================================= -->
        <section id="tab-receipts" class="tab-panel" role="tabpanel" aria-labelledby="tab-receipts-btn">
          <h2>Receipts</h2>
          <div id="receipts-summary"></div>
          <div id="receipts-list"></div>
        </section>

        <!-- ======================================================
             TAB: Season Overview
        ======================================================= -->
        <section id="tab-season" class="tab-panel" role="tabpanel" aria-labelledby="tab-season-btn">
          <h2>Season Overview</h2>

          <div id="season-overview-root" class="season-overview">
            <section>
              <h3 class="season-subheading">Standings</h3>
              <div class="season-standings-container">
                <table class="season-standings-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th>W-L-T</th>
                      <th>Win%</th>
                      <th>PF</th>
                      <th>PA</th>
                      <th>Diff</th>
                    </tr>
                  </thead>
                  <tbody id="season-standings-body">
                    <tr>
                      <td colspan="7" class="small">
                        Standings will populate once historical scores are available.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            <section>
              <h3 class="season-subheading">Analytics Snapshot</h3>
              <div id="season-metrics-container" class="season-metrics-container">
                <p class="small">
                  Season metrics will appear here once data loads: top scorers, best differentials,
                  schedule strength notes, and storyline blurbs.
                </p>
              </div>
            </section>
          </div>
        </section>

        <!-- ======================================================
             TAB: Insights
        ======================================================= -->
        <section id="tab-insights" class="tab-panel" role="tabpanel" aria-labelledby="tab-insights-btn">
          <h2>Insights</h2>

          <div class="season-overview">
            <section>
              <h3 class="season-subheading">Schedule Luck</h3>
              <div class="chart-card" style="height: 220px;">
                <canvas id="insights-luck-chart"></canvas>
              </div>

              <h3 class="season-subheading" style="margin-top: 14px;">Boom / Bust Profile</h3>
              <div class="chart-card" style="height: 220px;">
                <canvas id="insights-boom-bust-chart"></canvas>
              </div>
            </section>

            <section>
              <h3 class="season-subheading">Team Analytics</h3>
              <div class="season-standings-container">
                <table class="season-standings-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Team</th>
                      <th>W-L-T</th>
                      <th>PPG</th>
                      <th>Luck ΔW</th>
                      <th>vs Avg</th>
                      <th>Boom</th>
                      <th>Bust</th>
                    </tr>
                  </thead>
                  <tbody id="insights-table-body">
                    <tr>
                      <td colspan="8" class="small">
                        Insights will populate once historical scores are available.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="small" style="margin-top: 8px;">
                <strong>Key:</strong> Luck ΔW = actual wins minus expected wins from all-play.
                “vs Avg” = record vs the weekly league-average score.
                Boom/Bust = weeks above μ + σ or below μ – σ.
              </p>
            </section>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- ==========================================================
       Vendor: Chart.js
  =========================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ==========================================================
       Sleeper player metadata preload
  =========================================================== -->
  <script>
    window.__PLAYER_MAP_READY__ = (async function preloadSleeperPlayers() {
      try {
        const res = await fetch("https://api.sleeper.app/v1/players/nfl");
        const data = await res.json();
        const map = {};
        for (const [id, p] of Object.entries(data)) {
          map[id] = {
            full_name:
              p.full_name ||
              ((p.first_name || "") + " " + (p.last_name || "")).trim(),
            position: p.position,
            team: p.team,
            color: p.team_color || "#9ca3af",
          };
        }
        window.__SLEEPER_PLAYER_MAP__ = map;
        console.log("[player-map] Loaded", Object.keys(map).length, "players");
        return map;
      } catch (err) {
        console.warn("[player-map] Failed to load Sleeper player map", err);
        window.__SLEEPER_PLAYER_MAP__ = {};
        return {};
      }
    })();
  </script>

  <!-- ==========================================================
       Supabase + Phrase Engine (for recap lines + KTC)
  =========================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="league_config.js"></script>
  <script type="module" src="supabase.js"></script>
  <script src="phrases.js"></script>
  <script type="module" src="ktc_client.js"></script>

  <!-- ==========================================================
       App scripts – order matters
  =========================================================== -->
  <script src="sleeper_client.js"></script>
  <script src="models.js"></script>
  <script src="projections.js"></script>
  <script src="newsletter.js"></script>
  <script src="charts.js"></script>
  <script src="team_profile.js"></script>
  <script type="module" src="receipts.js"></script>
  <script src="insights.js"></script>
  <script src="season_overview.js"></script>
  <script src="playoffs_bracket.js"></script>

  <!-- ==========================================================
       Inline bootstrap: tabs + summary + detail scope + rosters
  =========================================================== -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      initTabs();
      initSummaryDialog();
      initMatchupDetailScopeToggle();
      initRostersTab();
    });

    // -----------------------
    // Tabs
    // -----------------------
    function initTabs() {
      const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));
      const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

      function setActive(target) {
        tabButtons.forEach((b) => {
          const isActive = b.getAttribute("data-tab") === target;
          b.classList.toggle("active", isActive);
          b.setAttribute("aria-selected", isActive ? "true" : "false");
        });

        tabPanels.forEach((p) => {
          const isActive = p.id === "tab-" + target;
          p.classList.toggle("active", isActive);
          p.toggleAttribute("hidden", !isActive);
        });
      }

      // Ensure non-active panels are hidden initially
      tabPanels.forEach((p) => {
        if (!p.classList.contains("active")) p.setAttribute("hidden", "");
      });

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab");
          if (!target) return;
          setActive(target);
        });
      });
    }

    // -----------------------
    // Summary dialog
    // -----------------------
    function initSummaryDialog() {
      const btn = document.getElementById("open-summary-btn");
      const dlg = document.getElementById("summary-dialog");
      const closeBtn = document.getElementById("summary-dialog-close");
      if (!btn || !dlg) return;

      btn.addEventListener("click", () => {
        if (typeof dlg.showModal === "function") dlg.showModal();
      });

      // Optional: clicking the backdrop closes (browser dependent; this is safe)
      dlg.addEventListener("click", (e) => {
        const rect = dlg.getBoundingClientRect();
        const inDialog =
          rect.top <= e.clientY &&
          e.clientY <= rect.top + rect.height &&
          rect.left <= e.clientX &&
          e.clientX <= rect.left + rect.width;
        if (!inDialog) dlg.close();
      });

      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          try { dlg.close(); } catch {}
        });
      }
    }

    // -----------------------
    // Matchup detail scope toggle (Starters / All)
    // -----------------------
    function initMatchupDetailScopeToggle() {
      const btnStarters = document.getElementById("detail-filter-starters");
      const btnAll = document.getElementById("detail-filter-all");

      if (!btnStarters || !btnAll) return;

      function setScope(scope) {
        const isStarters = scope === "starters";
        window.__MATCHUP_DETAIL_SCOPE__ = scope;

        btnStarters.classList.toggle("active", isStarters);
        btnAll.classList.toggle("active", !isStarters);

        btnStarters.setAttribute("aria-selected", isStarters ? "true" : "false");
        btnAll.setAttribute("aria-selected", !isStarters ? "true" : "false");

        window.dispatchEvent(
          new CustomEvent("matchup-detail-scope", { detail: { scope } })
        );
      }

      btnStarters.addEventListener("click", () => setScope("starters"));
      btnAll.addEventListener("click", () => setScope("all"));

      setScope("starters");
    }

    // -----------------------
    // Rosters tab (single-selection, full team detail)
    // -----------------------
    function initRostersTab() {
      const rosterSelect = document.getElementById("roster-select");
      const detailBody = document.getElementById("roster-detail-body");
      const detailHeader = document.getElementById("roster-detail-header");
      if (!rosterSelect || !detailBody || !detailHeader) return;

      let currentBundle = null;
      let selectedRosterId = null;

      function buildRosterSelector(bundle) {
        const users = bundle.users || [];
        const rosters = bundle.rosters || [];

        const rosterNameMap = {};
        rosters.forEach((r) => {
          const owner = users.find((u) => u.user_id === r.owner_id);
          const display =
            (r.metadata && r.metadata.team_name) ||
            (owner && (owner.display_name || owner.username)) ||
            `Team ${r.roster_id}`;
          rosterNameMap[r.roster_id] = display;
        });

        rosterSelect.innerHTML = Object.entries(rosterNameMap)
          .map(([id, name]) => {
            return `<button type="button" class="roster-select-btn" data-id="${id}">${name}</button>`;
          })
          .join("");

        rosterSelect.addEventListener("click", (e) => {
          const btn = e.target.closest(".roster-select-btn");
          if (!btn) return;

          const id = Number(btn.dataset.id);
          if (!Number.isFinite(id)) return;

          selectedRosterId = id;

          // Visual selection state
          rosterSelect.querySelectorAll(".roster-select-btn").forEach((b) => {
            b.classList.toggle("selected", b === btn);
          });

          if (
            !currentBundle ||
            !window.PlayoffNewsletterApp ||
            typeof window.PlayoffNewsletterApp.renderRosterDetail !== "function"
          ) {
            return;
          }

          const roster = (currentBundle.rosters || []).find(
            (r) => r.roster_id === id
          );

          window.PlayoffNewsletterApp.renderRosterDetail(roster);
        });
      }

      // Poll for __LAST_BUNDLE__ produced by newsletter.js
      const poll = setInterval(() => {
        const bundle = window.__LAST_BUNDLE__;
        if (!bundle || !bundle.rosters || !bundle.users) return;

        clearInterval(poll);
        currentBundle = bundle;
        buildRosterSelector(bundle);
      }, 350);
    }
  </script>
</body>
</html>
